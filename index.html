<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>WebRTSP</title>
    <link rel="stylesheet" href="css/WebRTSP.css">
    <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script type="text/javascript" src="Config.js"></script>
    <script>
      let server = null;
      if(window.location.protocol === 'http:')
        server = `ws://${window.location.hostname}:${WebRTSPPort}/`;
      else
        server = `wss://${window.location.hostname}:${WebRTSPPort}/`;

      let streamersList = undefined;

      function updateSources(list) {
        const buttonsContainer =
          document.querySelector("#buttonsContainer");
        buttonsContainer.innerHTML = "";
        if(list && list.size > 0) {
          list.forEach((description, streamerName) => {
            let button = document.createElement("button");
            button.innerHTML = streamerName;
            button.title = description;
            button.dataset.streamerName = streamerName;
            button.dataset.streamerDescription = description;
            button.onclick = function() { connect(this.dataset.streamerName); }
            buttonsContainer.appendChild(button);
          });
        } else {
          buttonsContainer.hidden = true;
        }
      }

      let webrtsp = null;

      function connect(streamerName) {
        if(streamerName)
          document.title = streamerName;

        webrtsp.connect(server, streamerName);
      }

      async function onLoad() {
        let WebRTSP = await import("./WebRTSP.mjs");
        const videoElement =
          document.querySelector("#video");
        webrtsp = new WebRTSP.WebRTSP(
          videoElement,
          [{
            urls: ["stun:stun.l.google.com:19302"]
          }]);

          webrtsp.events.addEventListener("list", (event) => {

            updateSources(event.detail.list);

            if(event.detail.list.size > 0) {
              const requiredItem = Math.floor(Math.random() * event.detail.list.size);
              let it = event.detail.list.keys();
              for(let i = 0; i < requiredItem; ++i)
                it.next();
              webrtsp.streamerName = it.next().value;
            } else
              webrtsp.streamerName = "*";

            document.title = webrtsp.streamerName;
          })

          connect();
      }

      function logStats() {
        webrtsp.session.peerConnection.getStats()
          .then((report) => {
            report.forEach(entry => {
              if(entry.type == "candidate-pair" ) {
                if(entry.nominated && entry.totalRoundTripTime) {
                  console.log(
                    `Candidate pair "${entry.id}":`,
                    JSON.stringify(
                      entry,
                      [
                        // "bytesReceived",
                        // "bytesSent",
                        // "timestamp",
                        "totalRoundTripTime"
                      ], 4));
                }
              } else if(entry.type == "remote-candidate" || entry.type == "local-candidate") {
              } else if(entry.type == "certificate") {
              } else if(entry.type == "codec") {
              } else if(entry.type == "inbound-rtp") {
                  if(entry.packetsReceived) {
                    entry.packetsLostPct = entry.packetsLost/entry.packetsReceived;
                  }
                  console.log(
                    `Inbound RTP stream "${entry.id}":`,
                    JSON.stringify(entry,
                      [
                        "kind",
                        //"lastPacketReceivedTimestamp",
                        //"framesDecoded",
                        //"framesDropped",
                        "firCount", // Full Intra Request
                        "pliCount", // Picture Loss Indication
                        "nackCount",
                        //"bytesReceived",
                        "packetsReceived",
                        "packetsLost",
                        "packetsLostPct"
                      ], 4));
              } else if(entry.type == "transport") {
                  /*
                  console.log(
                    `Transport "${entry.id}":`,
                    JSON.stringify(
                      entry,
                      [
                        "dtlsState",
                        "bytesReceived",
                        "bytesSent",
                        "timestamp"
                      ], 4));
                  */
              } else if(entry.type == "peer-connection") {
              } else if(entry.type == "stream") {
              } else if(entry.type == "track") {
                if(entry.remoteSource) {
                  if(entry.jitterBufferEmittedCount) {
                    entry.jitterBufferAvgDelay = entry.jitterBufferDelay/entry.jitterBufferEmittedCount;
                  }
                  console.log(
                    `Track "${entry.id}":`,
                    JSON.stringify(
                      entry,
                      [
                        "kind",
                        //"framesDecoded",
                        //"framesDropped",
                        "jitterBufferDelay",
                        "jitterBufferEmittedCount",
                        "jitterBufferAvgDelay"
                      ], 4));
                }
              } else if(entry.type == "remote-outbound-rtp") {
              } else {
                console.log(`type: ${entry.type}, id: ${entry.id}`, entry);
              }
            });
          }
        )
      }
    </script>
  </head>
  <body onload="onLoad()">
    <div id="rootContainer">
      <div id="buttonsContainer">
      </div>
      <div id="videoContainer">
        <video id="video" autoplay="true" muted="muted"> </video>
      </div>
      <button id="statsButton" onclick="logStats()">Stats</button>
    </div>
  </body>
</html>
